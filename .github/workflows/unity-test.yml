name: Unity EditMode Tests

on: [push, pull_request]

jobs:
  run-tests:
    name: ğŸ¦Š Run unity tests
    runs-on: ubuntu-latest # ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã™ã‚‹ä»®æƒ³OS
    permissions:
      contents: read  # èª­ã¿å–ã‚Šæ¨©é™ã®ã¿
      
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    # Unity Libraryã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - name: Cache Unity Library
      uses: actions/cache@v3
      with:
        path: Library
        key: Library-EditMode-${{ hashFiles('ProjectSettings/ProjectVersion.txt') }}
        restore-keys: |
          Library-EditMode-
          Library-

    # EditModeãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    - name: Run EditMode Tests
      uses: game-ci/unity-test-runner@v4
      id: editmode-tests
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        testMode: EditMode
        artifactsPath: test-results
        # githubTokenå‰Šé™¤ã§Status Checkç„¡åŠ¹åŒ–
      continue-on-error: true

    # ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: editmode-test-results
        path: test-results
        retention-days: 7

    # ãƒ†ã‚¹ãƒˆçµæœã®è§£æ
    - name: Parse Test Results
      id: parse-results
      if: always()
      run: |
        echo "ğŸ” Parsing EditMode test results..."
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        result="âŒ Failed"
        details="No test results found"
        
        # XMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "test-results/editmode-results.xml" ]; then
          echo "âœ… Test results file found"
          
          # ãƒ†ã‚¹ãƒˆæ•°å€¤ã®æŠ½å‡º
          tests=$(grep -o 'tests="[0-9]*"' test-results/editmode-results.xml | cut -d'"' -f2 | head -1)
          failures=$(grep -o 'failures="[0-9]*"' test-results/editmode-results.xml | cut -d'"' -f2 | head -1)
          errors=$(grep -o 'errors="[0-9]*"' test-results/editmode-results.xml | cut -d'"' -f2 | head -1)
          time=$(grep -o 'duration="[0-9.]*"' test-results/editmode-results.xml | cut -d'"' -f2 | head -1)
          
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
          tests=${tests:-0}
          failures=${failures:-0}
          errors=${errors:-0}
          time=${time:-0}
          
          echo "ğŸ“Š Tests: $tests, Failures: $failures, Errors: $errors, Duration: ${time}s"
          
          # çµæœåˆ¤å®š
          if [ "$failures" = "0" ] && [ "$errors" = "0" ] && [ "$tests" != "0" ]; then
            result="âœ… Passed"
            details="All $tests tests passed in ${time}s"
          elif [ "$tests" = "0" ]; then
            result="âš ï¸ No Tests"
            details="No tests were executed"
          else
            result="âŒ Failed"
            details="$failures failed, $errors errors out of $tests tests (${time}s)"
          fi
        else
          echo "âŒ Test results file not found"
          result="âš ï¸ No Results"
          details="Test execution may have failed"
        fi
        
        # GitHubç’°å¢ƒå¤‰æ•°ã«è¨­å®š
        echo "result=$result" >> $GITHUB_OUTPUT
        echo "details=$details" >> $GITHUB_OUTPUT
        echo "tests=$tests" >> $GITHUB_OUTPUT
        echo "failures=$failures" >> $GITHUB_OUTPUT
        echo "errors=$errors" >> $GITHUB_OUTPUT

    # ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã«çµæœè¡¨ç¤º
    - name: Display Results
      if: always()
      run: |
        echo "# ğŸ® Unity EditMode Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.parse-results.outputs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Details:** ${{ steps.parse-results.outputs.details }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ã¿è©³ç´°è¡¨ç¤º
        if [ "${{ steps.parse-results.outputs.tests }}" != "0" ]; then
          echo "## ğŸ“‹ Test Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Tests | ${{ steps.parse-results.outputs.tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $(( ${{ steps.parse-results.outputs.tests }} - ${{ steps.parse-results.outputs.failures }} - ${{ steps.parse-results.outputs.errors }} )) |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.parse-results.outputs.failures }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.parse-results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "## ğŸ“ Build Info" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

    # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã•ã›ã‚‹
    - name: Fail on Test Failure
      if: steps.parse-results.outputs.result == 'âŒ Failed'
      run: |
        echo "âŒ EditMode tests failed"
        echo "Check the job summary for detailed results"
        exit 1
